<!DOCTYPE html>
<html>
    <head>
        <title>neuropredict.algorithms &mdash; neuropredict 0.4.7+59.g49987e2.dirty documentation</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=auto, initial-scale=auto, maximum-scale=1.0, user-scalable=no" />
        <link rel="shortcut icon" href="../../_static/favicon.ico" />

        <link rel="stylesheet" href="../../_static/bootstrap/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="../../_static/bernard.css" type="text/css" />
        <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

        <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT       : '../../',
            VERSION        : '0.4.7+59.g49987e2.dirty',
            COLLAPSE_INDEX : false,
            FILE_SUFFIX    : '.html',
            HAS_SOURCE     : true
        };
        </script>

        
    </head>

    <body>
        <!--<div class="ribbon">-->
            <!--<a href="https://github.com/raamana">Fork me on GitHub!</a>-->
        <!--</div>-->

        <!--<div class="container text-center">-->
            <!--<a class="logo" href="http://bernardphp.com">Bernard</a>-->
        <!--</div>-->

        <hr />

        <div class="container">
            <div class="row">
                <div class="col-md-3 toc">
                    

                    
                        <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html#predictive-analysis">Predictive analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../longterm.html">Long term goals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#requirements">Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_cli.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Named Arguments">Named Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Input data and formats">Input data and formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Cross-validation">Cross-validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Predictive Model">Predictive Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Visualization">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usage_cli.html#Computing">Computing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Input formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html#interfaces-to-neuroimaging-tools">Interfaces to Neuroimaging tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html#arbitrary-feature-input">Arbitrary feature input</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../results.html">Report</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../results.html#interpretation">Interpretation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../results.html#comparison-of-predictive-accuracy">Comparison of predictive accuracy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../results.html#comparison-of-misclassification-rates">Comparison of misclassification rates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation.html">Implemenation details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citation</a></li>
</ul>

                    

                    <a href="#" class="navbar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                </div>

                <div class="col-md-9 body">
                    
  <h1>Source code for neuropredict.algorithms</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_pipeline&#39;</span><span class="p">,</span> <span class="s1">&#39;get_feature_importance&#39;</span><span class="p">,]</span>

<span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">config_neuropredict</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">ExtraTreesClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="k">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="k">import</span> <span class="n">mutual_info_classif</span><span class="p">,</span> <span class="n">f_classif</span><span class="p">,</span> <span class="n">SelectKBest</span><span class="p">,</span> <span class="n">VarianceThreshold</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="k">import</span> <span class="n">Pipeline</span>


<span class="k">def</span> <span class="nf">make_parameter_grid</span><span class="p">(</span><span class="n">estimator_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">named_ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a sklearn.pipeline compatible dict of named ranges,</span>
<span class="sd">        given an list of tuples, wherein each element is (param_name, param_values).</span>
<span class="sd">        Here, a param_name is the name of an estimator&#39;s parameter, and</span>
<span class="sd">            param_values are an iterable of values for that parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    estimator_name : str</span>
<span class="sd">        Valid python identifier to name the current step of the pipeline.</span>
<span class="sd">        Example: estimator_name=&#39;random_forest_clf&#39;</span>

<span class="sd">    named_ranges : list of tuples</span>
<span class="sd">        List of tuples of size 2, wherein each element is (param_name, param_values).</span>
<span class="sd">        Here, a param_name is the name of an estimator&#39;s parameter, and</span>
<span class="sd">            param_values are an iterable of values for that parameter.</span>

<span class="sd">        named_ranges = [(&#39;n_estimators&#39;, [50, 100, 500]),</span>
<span class="sd">                        (&#39;max_features&#39;, [10, 20, 50, 100]),</span>
<span class="sd">                        (&#39;min_samples_leaf&#39;, [3, 5, 10, 20])]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    param_grid : dict</span>
<span class="sd">        An sklearn.pipeline compatible dict of named parameter ranges.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">named_ranges</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">estimator_name</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">prepend_param_name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">string</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estimator_name</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_values</span> <span class="ow">in</span> <span class="n">named_ranges</span><span class="p">:</span>
        <span class="n">param_grid</span><span class="p">[</span><span class="n">prepend_param_name</span><span class="p">(</span><span class="n">param_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">param_values</span>

    <span class="k">return</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">compute_reduced_dimensionality</span><span class="p">(</span><span class="n">select_method</span><span class="p">,</span> <span class="n">train_class_sizes</span><span class="p">,</span> <span class="n">train_data_dim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the number of features to retain for feature selection based on method chosen.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    select_method : str</span>
<span class="sd">        Type of feature selection.</span>
<span class="sd">    train_class_sizes : iterable</span>
<span class="sd">        Sizes of all classes in training set.</span>
<span class="sd">    train_data_dim : int</span>
<span class="sd">        Data dimensionality for the feature set.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        Reduced dimensionality n, such that 1 &lt;= n &lt;= train_data_dim.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If method choice is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># default to use them all.</span>
    <span class="k">if</span> <span class="n">select_method</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">train_data_dim</span>


    <span class="k">def</span> <span class="nf">do_sqrt</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">do_tenth</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">do_log2</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


    <span class="n">get_reduced_dim</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tenth&#39;</span><span class="p">:</span> <span class="n">do_tenth</span><span class="p">,</span>
                       <span class="s1">&#39;sqrt&#39;</span> <span class="p">:</span> <span class="n">do_sqrt</span><span class="p">,</span>
                       <span class="s1">&#39;log2&#39;</span> <span class="p">:</span> <span class="n">do_log2</span><span class="p">}</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">select_method</span> <span class="ow">in</span> <span class="n">get_reduced_dim</span><span class="p">:</span>
            <span class="n">smallest_class_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">train_class_sizes</span><span class="p">)</span>
            <span class="n">calc_size</span> <span class="o">=</span> <span class="n">get_reduced_dim</span><span class="p">[</span><span class="n">select_method</span><span class="p">](</span><span class="n">smallest_class_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># arg could be string coming from command line</span>
            <span class="n">calc_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">select_method</span><span class="p">)</span>
        <span class="n">reduced_dim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">calc_size</span><span class="p">,</span> <span class="n">train_data_dim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select_method</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">select_method</span> <span class="o">&gt;</span> <span class="n">train_data_dim</span><span class="p">:</span>  <span class="c1"># case of Inf is covered</span>
            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">train_data_dim</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reducing the feature selection size to </span><span class="si">{}</span><span class="s1">, &#39;</span>
                  <span class="s1">&#39;to accommondate the current feature set.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_data_dim</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">select_method</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select_method</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">select_method</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fraction for the reduced dimensionality must be finite within (0.0, 1.0).&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">select_method</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">select_method</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">train_data_dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">train_data_dim</span> <span class="o">/</span> <span class="n">select_method</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Invalid method to choose size of feature selection. It can only be 1) string or 2) finite integer (&lt; data dimensionality) or 3) a fraction between 0.0 and 1.0 !&#39;</span><span class="p">)</span>

    <span class="c1"># ensuring it is an integer &gt;= 1</span>
    <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">reduced_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">reduced_dim</span>


<span class="k">def</span> <span class="nf">add_new_params</span><span class="p">(</span><span class="n">old_grid</span><span class="p">,</span> <span class="n">new_grid</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds new items (parameters) in-place to old dict (of parameters),</span>
<span class="sd">    ensuring no overlap in new parameters with old parameters which prevents silent overwrite.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">new_grid</span><span class="p">:</span>
        <span class="n">new_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">old_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_params</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">new_params</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Overlap in parameters between </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> of the chosen pipeline.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>

        <span class="n">old_grid</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_grid</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">get_DecisionTreeClassifier</span><span class="p">(</span><span class="n">reduced_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Random Forest classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        One of the dimensionalities to be tried.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">        The &#39;light&#39; option provides a lighter and much less exhaustive grid search to speed up optimization.</span>
<span class="sd">        Parameter values will be chosen based on defaults, previous studies and &quot;folk wisdom&quot;.</span>
<span class="sd">        Useful to get a &quot;very rough&quot; idea of performance for different feature sets, and for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">grid_search_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="n">splitter_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

        <span class="c1"># if user supplied reduced_dim, it will be tried also. Default None --&gt; all features.</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]:</span>
        <span class="n">splitter_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]:</span>  <span class="c1"># single point on the hyper-parameter grid</span>
        <span class="n">splitter_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">,]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduced_dim</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized option to set level of grid search.&#39;</span><span class="p">)</span>

    <span class="c1"># name clf_model chosen to enable generic selection classifier later on</span>
    <span class="c1"># not optimizing over number of features to save time</span>
    <span class="n">clf_name</span> <span class="o">=</span> <span class="s1">&#39;decision_tree_clf&#39;</span>
    <span class="n">param_list_values</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;criterion&#39;</span><span class="p">,</span> <span class="n">split_criteria</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;splitter&#39;</span><span class="p">,</span> <span class="n">splitter_strategies</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span> <span class="n">range_min_leafsize</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;max_features&#39;</span><span class="p">,</span> <span class="n">range_max_features</span><span class="p">),</span>
                         <span class="p">]</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">make_parameter_grid</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">param_list_values</span><span class="p">)</span>

    <span class="n">dtc</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dtc</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">get_ExtraTreesClassifier</span><span class="p">(</span><span class="n">reduced_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Random Forest classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        One of the dimensionalities to be tried.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">        The &#39;light&#39; option provides a lighter and much less exhaustive grid search to speed up optimization.</span>
<span class="sd">        Parameter values will be chosen based on defaults, previous studies and &quot;folk wisdom&quot;.</span>
<span class="sd">        Useful to get a &quot;very rough&quot; idea of performance for different feature sets, and for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">grid_search_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># np.arange(0., 0.41, 0.1)</span>

        <span class="c1"># if user supplied reduced_dim, it will be tried also. Default None --&gt; all features.</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]:</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]:</span>  <span class="c1"># single point on the hyper-parameter grid</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduced_dim</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized option to set level of grid search.&#39;</span><span class="p">)</span>

    <span class="c1"># name clf_model chosen to enable generic selection classifier later on</span>
    <span class="c1"># not optimizing over number of features to save time</span>
    <span class="n">clf_name</span> <span class="o">=</span> <span class="s1">&#39;extra_trees_clf&#39;</span>
    <span class="n">param_list_values</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="n">range_num_trees</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;criterion&#39;</span><span class="p">,</span> <span class="n">split_criteria</span><span class="p">),</span>
                         <span class="c1"># (&#39;min_impurity_decrease&#39;,  range_min_impurity), # ignoring this</span>
                         <span class="p">(</span><span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span> <span class="n">range_min_leafsize</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;max_features&#39;</span><span class="p">,</span> <span class="n">range_max_features</span><span class="p">),</span>
                         <span class="p">]</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">make_parameter_grid</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">param_list_values</span><span class="p">)</span>

    <span class="n">rfc</span> <span class="o">=</span> <span class="n">ExtraTreesClassifier</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">,</span>
                               <span class="n">n_estimators</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">range_num_trees</span><span class="p">),</span>
                               <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rfc</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">get_svc</span><span class="p">(</span><span class="n">reduced_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the SVM classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        One of the dimensionalities to be tried.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">        The &#39;light&#39; option provides a lighter and much less exhaustive grid search to speed up optimization.</span>
<span class="sd">        Parameter values will be chosen based on defaults, previous studies and &quot;folk wisdom&quot;.</span>
<span class="sd">        Useful to get a &quot;very rough&quot; idea of performance for different feature sets, and for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">grid_search_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="c1">#TODO try pruning values based on their processing time/redundancy</span>
        <span class="n">range_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">range_kernel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
        <span class="n">range_degree</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_gamma</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
        <span class="n">range_coef0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))))</span>

        <span class="c1"># if user supplied reduced_dim, it will be tried also. Default None --&gt; all features.</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]:</span>
        <span class="n">range_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">range_kernel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_gamma</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="n">range_coef0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))))</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

        <span class="c1"># setting for sake of completeness, although this will be ignored</span>
        <span class="n">range_degree</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]:</span>  <span class="c1"># single point on the hyper-parameter grid</span>
        <span class="n">range_penalty</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_kernel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_coef0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduced_dim</span><span class="p">]</span>

        <span class="c1"># setting for sake of completeness, although this will be ignored</span>
        <span class="n">range_degree</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized option to set level of grid search.&#39;</span><span class="p">)</span>

    <span class="n">clf_name</span> <span class="o">=</span> <span class="s1">&#39;svc&#39;</span>
    <span class="n">param_list_values</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">range_penalty</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="n">range_kernel</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;degree&#39;</span><span class="p">,</span> <span class="n">range_degree</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">range_gamma</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;coef0&#39;</span><span class="p">,</span> <span class="n">range_coef0</span><span class="p">),</span>
                         <span class="p">]</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">make_parameter_grid</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">param_list_values</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="k">import</span> <span class="n">SVC</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clf</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">get_RandomForestClassifier</span><span class="p">(</span><span class="n">reduced_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Random Forest classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        One of the dimensionalities to be tried.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">        The &#39;light&#39; option provides a lighter and much less exhaustive grid search to speed up optimization.</span>
<span class="sd">        Parameter values will be chosen based on defaults, previous studies and &quot;folk wisdom&quot;.</span>
<span class="sd">        Useful to get a &quot;very rough&quot; idea of performance for different feature sets, and for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">grid_search_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># np.arange(0., 0.41, 0.1)</span>

        <span class="c1"># if user supplied reduced_dim, it will be tried also. Default None --&gt; all features.</span>
        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]:</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]:</span>  <span class="c1"># single point on the hyper-parameter grid</span>
        <span class="n">range_num_trees</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">split_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_leafsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_min_impurity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">range_max_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduced_dim</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized option to set level of grid search.&#39;</span><span class="p">)</span>

    <span class="c1"># name clf_model chosen to enable generic selection classifier later on</span>
    <span class="c1"># not optimizing over number of features to save time</span>
    <span class="n">clf_name</span> <span class="o">=</span> <span class="s1">&#39;random_forest_clf&#39;</span>
    <span class="n">param_list_values</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="n">range_num_trees</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;criterion&#39;</span><span class="p">,</span> <span class="n">split_criteria</span><span class="p">),</span>
                         <span class="c1"># (&#39;min_impurity_decrease&#39;,  range_min_impurity), # ignoring this</span>
                         <span class="p">(</span><span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span> <span class="n">range_min_leafsize</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;max_features&#39;</span><span class="p">,</span> <span class="n">range_max_features</span><span class="p">),</span>
                         <span class="p">]</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">make_parameter_grid</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">param_list_values</span><span class="p">)</span>

    <span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">range_num_trees</span><span class="p">),</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rfc</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">get_xgboost</span><span class="p">(</span><span class="n">reduced_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the extremene gradient boosting (XGB) classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reduced_dim : int</span>
<span class="sd">        One of the dimensionalities to be tried.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">        The &#39;light&#39; option provides a lighter and much less exhaustive grid search to speed up optimization.</span>
<span class="sd">        Parameter values will be chosen based on defaults, previous studies and &quot;folk wisdom&quot;.</span>
<span class="sd">        Useful to get a &quot;very rough&quot; idea of performance for different feature sets, and for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">xgboost</span> <span class="k">import</span> <span class="n">XGBClassifier</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">grid_search_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="c1"># TODO consult literature for better selection of ranges</span>
        <span class="n">range_max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="c1"># range_min_child_weight = []</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">range_subsample</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

        <span class="n">range_colsample_bytree</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="n">range_learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

        <span class="n">range_num_feature</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]:</span>
        <span class="n">range_max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
        <span class="c1"># range_min_child_weight = []</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_subsample</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

        <span class="n">range_colsample_bytree</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="n">range_learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">range_num_feature</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_search_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]:</span>  <span class="c1"># single point on the hyper-parameter grid</span>
        <span class="n">range_max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">]</span>
        <span class="c1"># range_min_child_weight = []</span>
        <span class="n">range_gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_subsample</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">range_colsample_bytree</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">range_learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,]</span>

        <span class="n">range_num_feature</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduced_dim</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized option to set level of grid search.&#39;</span><span class="p">)</span>

    <span class="c1"># name clf_model chosen to enable generic selection classifier later on</span>
    <span class="c1"># not optimizing over number of features to save time</span>
    <span class="n">clf_name</span> <span class="o">=</span> <span class="s1">&#39;xgboost_clf&#39;</span>
    <span class="n">param_list_values</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="n">range_max_depth</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">range_learning_rate</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">range_gamma</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;colsample_bytree&#39;</span><span class="p">,</span> <span class="n">range_colsample_bytree</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;subsample&#39;</span><span class="p">,</span> <span class="n">range_subsample</span><span class="p">),</span>
                         <span class="p">(</span><span class="s1">&#39;num_feature&#39;</span><span class="p">,</span> <span class="n">range_num_feature</span><span class="p">),</span>
                         <span class="p">]</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">make_parameter_grid</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">param_list_values</span><span class="p">)</span>

    <span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">num_feature</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">,</span>
                        <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                        <span class="n">predictor</span><span class="o">=</span><span class="s1">&#39;cpu_predictor&#39;</span><span class="p">,</span>
                        <span class="n">nthread</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># to avoid interactions with other parallel tasks</span>
                        <span class="p">)</span>

    <span class="k">return</span> <span class="n">xgb</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>



<span class="k">def</span> <span class="nf">get_classifier</span><span class="p">(</span><span class="n">classifier_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_classifier</span><span class="p">,</span>
                   <span class="n">reduced_dim</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                   <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the named classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classifier_name : str</span>
<span class="sd">        String referring to a valid scikit-learn classifier.</span>

<span class="sd">    reduced_dim : int or str</span>
<span class="sd">        Reduced dimensionality, either an integer or &quot;all&quot;, which defaults to using everything.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    clf : sklearn.estimator</span>
<span class="sd">        Valid scikit-learn estimator.</span>
<span class="sd">    clf_name : str</span>
<span class="sd">        String identifying the classifier to construct the parameter grid.</span>
<span class="sd">    param_grid : dict</span>
<span class="sd">        Dict of named ranges to construct the parameter grid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">classifier_name</span> <span class="o">=</span> <span class="n">classifier_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">map_to_method</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">randomforestclassifier</span><span class="o">=</span><span class="n">get_RandomForestClassifier</span><span class="p">,</span>
                         <span class="n">extratreesclassifier</span><span class="o">=</span><span class="n">get_ExtraTreesClassifier</span><span class="p">,</span>
                         <span class="n">decisiontreeclassifier</span><span class="o">=</span><span class="n">get_DecisionTreeClassifier</span><span class="p">,</span>
                         <span class="n">svm</span><span class="o">=</span><span class="n">get_svc</span><span class="p">,</span>
                         <span class="n">xgboost</span><span class="o">=</span><span class="n">get_xgboost</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">classifier_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_to_method</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Invalid name or classifier not implemented.&#39;</span><span class="p">)</span>

    <span class="n">clf_builder</span> <span class="o">=</span> <span class="n">map_to_method</span><span class="p">[</span><span class="n">classifier_name</span><span class="p">]</span>
    <span class="n">clf</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span> <span class="o">=</span> <span class="n">clf_builder</span><span class="p">(</span><span class="n">reduced_dim</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clf</span><span class="p">,</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">param_grid</span>


<span class="k">def</span> <span class="nf">get_feature_selector</span><span class="p">(</span><span class="n">feat_selector_name</span><span class="o">=</span><span class="s1">&#39;variancethreshold&#39;</span><span class="p">,</span>
                         <span class="n">reduced_dim</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the named classifier and its parameter grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feat_selector_name : str</span>
<span class="sd">        String referring to a valid scikit-learn feature selector.</span>
<span class="sd">    reduced_dim : str or int</span>
<span class="sd">        Reduced dimensionality, either an integer or &quot;all&quot;, which defaults to using everything.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    feat_selector : sklearn.feature_selection method</span>
<span class="sd">        Valid scikit-learn feature selector.</span>
<span class="sd">    clf_name : str</span>
<span class="sd">        String identifying the feature selector to construct the parameter grid.</span>
<span class="sd">    param_grid : dict</span>
<span class="sd">        Dict of named ranges to construct the parameter grid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fs_name</span> <span class="o">=</span> <span class="n">feat_selector_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fs_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;selectkbest_mutual_info_classif&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="c1"># no param optimization for feat selector for now.</span>
        <span class="n">feat_selector</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_classif</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">)</span>
        <span class="c1"># TODO optimize the num features to select as part of grid search</span>
        <span class="n">fs_param_grid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">fs_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;selectkbest_f_classif&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="c1"># no param optimization for feat selector for now.</span>
        <span class="n">feat_selector</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_classif</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">)</span>
        <span class="n">fs_param_grid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">fs_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;variancethreshold&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="n">feat_selector</span> <span class="o">=</span> <span class="n">VarianceThreshold</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">variance_threshold</span><span class="p">)</span>
        <span class="n">fs_param_grid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Invalid name or feature selector not implemented.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feat_selector</span><span class="p">,</span> <span class="n">fs_name</span><span class="p">,</span> <span class="n">fs_param_grid</span>


<span class="k">def</span> <span class="nf">get_preprocessor</span><span class="p">(</span><span class="n">preproc_name</span><span class="o">=</span><span class="s1">&#39;RobustScaler&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a requested preprocessor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">RobustScaler</span>

    <span class="n">approved_preprocessor_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="nb">dir</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">))</span>

    <span class="n">preproc_name</span> <span class="o">=</span> <span class="n">preproc_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">preproc_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">approved_preprocessor_list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;chosen preprocessor not supported.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">preproc_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;robustscaler&#39;</span><span class="p">]:</span>
        <span class="n">preproc</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_centering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quantile_range</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">robust_scaler_iqr</span><span class="p">)</span>
        <span class="n">param_grid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO returning preprocessor blindly without any parameters</span>
        <span class="n">preproc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">,</span> <span class="n">preproc_name</span><span class="p">)</span>
        <span class="n">param_grid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">preproc</span><span class="p">,</span> <span class="n">preproc_name</span><span class="p">,</span> <span class="n">param_grid</span>


<div class="viewcode-block" id="get_pipeline"><a class="viewcode-back" href="../../neuropredict.html#neuropredict.algorithms.get_pipeline">[docs]</a><span class="k">def</span> <span class="nf">get_pipeline</span><span class="p">(</span><span class="n">train_class_sizes</span><span class="p">,</span> <span class="n">feat_sel_size</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span>
                 <span class="n">preprocessor_name</span><span class="o">=</span><span class="s1">&#39;robustscaler&#39;</span><span class="p">,</span>
                 <span class="n">feat_selector_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_feat_select_method</span><span class="p">,</span>
                 <span class="n">classifier_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_classifier</span><span class="p">,</span>
                 <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructor for pipeline (feature selection followed by a classifier).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_class_sizes : list</span>
<span class="sd">        sizes of different classes in the training set, to estimate the reduced dimensionality.</span>

<span class="sd">    feat_sel_size : str or int</span>
<span class="sd">        Method specify the method to estimate the reduced dimensionality.</span>
<span class="sd">        Choices : integer, or one of the methods in [&#39;sqrt&#39;, &#39;tenth&#39;, &#39;log2&#39;, &#39;all&#39;]</span>

<span class="sd">    num_features : int</span>
<span class="sd">        Number of features in the training set.</span>

<span class="sd">    classifier_name : str</span>
<span class="sd">        String referring to a valid scikit-learn classifier.</span>

<span class="sd">    feat_selector_name : str</span>
<span class="sd">        String referring to a valid scikit-learn feature selector.</span>

<span class="sd">    preprocessor_name : str</span>
<span class="sd">        String referring to a valid scikit-learn preprocessor</span>
<span class="sd">        (This can technically be another feature selector, although discourage).</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        If &#39;light&#39;, grid search resolution will be reduced to speed up optimization.</span>
<span class="sd">        If &#39;exhaustive&#39;, most values for most parameters will be user for optimization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pipeline : sklearn.pipeline.Pipeline</span>
<span class="sd">        Valid scikit learn pipeline.</span>
<span class="sd">    param_grid : dict</span>
<span class="sd">        Dict of named ranges to construct the parameter grid.</span>
<span class="sd">        Grid contains ranges for parameters of all the steps, including preprocessor, feature selector and classifier.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reduced_dim</span> <span class="o">=</span> <span class="n">compute_reduced_dimensionality</span><span class="p">(</span><span class="n">feat_sel_size</span><span class="p">,</span> <span class="n">train_class_sizes</span><span class="p">,</span> <span class="n">num_features</span><span class="p">)</span>

    <span class="n">preproc</span><span class="p">,</span> <span class="n">preproc_name</span><span class="p">,</span> <span class="n">preproc_param_grid</span> <span class="o">=</span> <span class="n">get_preprocessor</span><span class="p">(</span><span class="n">preprocessor_name</span><span class="p">)</span>
    <span class="n">estimator</span><span class="p">,</span> <span class="n">est_name</span><span class="p">,</span> <span class="n">clf_param_grid</span> <span class="o">=</span> <span class="n">get_classifier</span><span class="p">(</span><span class="n">classifier_name</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">,</span> <span class="n">grid_search_level</span><span class="p">)</span>
    <span class="n">feat_selector</span><span class="p">,</span> <span class="n">fs_name</span><span class="p">,</span> <span class="n">fs_param_grid</span> <span class="o">=</span> <span class="n">get_feature_selector</span><span class="p">(</span><span class="n">feat_selector_name</span><span class="p">,</span> <span class="n">reduced_dim</span><span class="p">)</span>

    <span class="c1"># composite grid of parameters from all steps</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">clf_param_grid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">add_new_params</span><span class="p">(</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">preproc_param_grid</span><span class="p">,</span> <span class="n">est_name</span><span class="p">,</span> <span class="n">preproc_name</span><span class="p">)</span>
    <span class="n">add_new_params</span><span class="p">(</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">fs_param_grid</span><span class="p">,</span> <span class="n">est_name</span><span class="p">,</span> <span class="n">fs_name</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">preproc_name</span><span class="p">,</span> <span class="n">preproc</span><span class="p">),</span>
             <span class="p">(</span><span class="n">fs_name</span><span class="p">,</span> <span class="n">feat_selector</span><span class="p">),</span>
             <span class="p">(</span><span class="n">est_name</span><span class="p">,</span> <span class="n">estimator</span><span class="p">)]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">param_grid</span></div>


<div class="viewcode-block" id="get_feature_importance"><a class="viewcode-back" href="../../neuropredict.html#neuropredict.algorithms.get_feature_importance">[docs]</a><span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="n">clf_name</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">index_selected_features</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="s2">&quot;Extracts the feature importance of input features, if available.&quot;</span>

    <span class="n">attr_importance</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;randomforestclassifier&#39;</span><span class="p">:</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;extratreesclassifier&#39;</span>  <span class="p">:</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;decisiontreeclassifier&#39;</span><span class="p">:</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;svm&#39;</span>                   <span class="p">:</span> <span class="s1">&#39;coef_&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;xgboost&#39;</span>               <span class="p">:</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">,}</span>

    <span class="n">feat_importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">attr_importance</span><span class="p">[</span><span class="n">clf_name</span><span class="p">]):</span>
        <span class="n">feat_importance</span><span class="p">[</span><span class="n">index_selected_features</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">attr_importance</span><span class="p">[</span><span class="n">clf_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">feat_importance</span></div>
</pre></div>

                </div>

                <div class="container">
                    
                </div>
            </div>
        </div>
            <script type="text/javascript" src="../../_static/jquery.js"></script>
            <script type="text/javascript" src="../../_static/underscore.js"></script>
            <script type="text/javascript" src="../../_static/doctools.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="../../_static/bernard.js"></script>
    </body>
</html>