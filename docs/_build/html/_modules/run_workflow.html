

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>run_workflow &mdash; neuropredict 0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="neuropredict 0.3 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> neuropredict
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../context.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../context.html#predictive-analysis">Predictive analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage_cli.html">Usage and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Input formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html#interfaces-to-neuroimaging-tools">Interfaces to Neuroimaging tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html#arbitray-feature-input">Arbitray feature input</a></li>
<li class="toctree-l1"><a class="reference internal" href="../results.html">Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation.html">Implemenation details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">neuropredict</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>run_workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for run_workflow</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;run_cli&#39;</span><span class="p">,</span> <span class="s1">&#39;get_parser&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">localtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pjoin</span><span class="p">,</span> <span class="n">exists</span> <span class="k">as</span> <span class="n">pexists</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyradigm</span> <span class="k">import</span> <span class="n">MLDataset</span>

<span class="c1"># the order of import is very important to avoid circular imports</span>
<span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">config_neuropredict</span> <span class="k">as</span> <span class="nn">cfg</span>
    <span class="kn">import</span> <span class="nn">rhst</span><span class="o">,</span> <span class="nn">visualize</span>
    <span class="kn">from</span> <span class="nn">freesurfer</span> <span class="k">import</span> <span class="n">aseg_stats_subcortical</span><span class="p">,</span> <span class="n">aseg_stats_whole_brain</span>
<span class="k">elif</span> <span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c1"># the order of import is very important to avoid circular imports</span>
    <span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">config_neuropredict</span> <span class="k">as</span> <span class="n">cfg</span>
    <span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">rhst</span><span class="p">,</span> <span class="n">visualize</span><span class="p">,</span> <span class="n">freesurfer</span><span class="p">,</span> <span class="n">model_comparison</span>
    <span class="kn">from</span> <span class="nn">neuropredict.freesurfer</span> <span class="k">import</span> <span class="n">aseg_stats_subcortical</span><span class="p">,</span> <span class="n">aseg_stats_whole_brain</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;neuropredict supports only 2.7 or Python 3+. Upgrade to Python 3+ is recommended.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_time_stamp</span><span class="p">():</span>
    <span class="s2">&quot;Returns a timestamp string.&quot;</span>

    <span class="c1"># just by the hour</span>
    <span class="k">return</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-T%H&#39;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">not_unspecified</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks for null values of a give variable! &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="get_parser"><a class="viewcode-back" href="../API.html#run_workflow.get_parser">[docs]</a><span class="k">def</span> <span class="nf">get_parser</span><span class="p">():</span>
    <span class="s2">&quot;Parser to specify arguments and their defaults.&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;neuropredict&quot;</span><span class="p">)</span>

    <span class="n">help_text_fs_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Absolute path to ``SUBJECTS_DIR`` containing the finished runs of Freesurfer parcellation (each subject named after its ID in the metadata file). E.g. ``--fs_subject_dir /project/freesurfer_v5.3`` &quot;&quot;&quot;</span>

    <span class="n">help_text_user_defined_folder</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;List of absolute paths to user&#39;s own features. </span>
<span class="s2">    </span>
<span class="s2">Format: Each of these folders contains a separate folder for each subject (named after its ID in the metadata file) containing a file called features.txt with one number per line. All the subjects (in a given folder) must have the number of features (#lines in file). Different parent folders (describing one feature set) can have different number of features for each subject, but they must all have the same number of subjects (folders) within them. </span>
<span class="s2">    </span>
<span class="s2">Names of each folder is used to annotate the results in visualizations. Hence name them uniquely and meaningfully, keeping in mind these figures will be included in your papers. For example,  </span>

<span class="s2">.. parsed-literal::</span>
<span class="s2">    </span>
<span class="s2">    --user_feature_paths /project/fmri/ /project/dti/ /project/t1_volumes/ </span>

<span class="s2">Only one of ``--pyradigm_paths``, ``user_feature_paths`` and ``daa_matrix_path`` options can be specified. &quot;&quot;&quot;</span>

    <span class="n">help_text_pyradigm_paths</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; Path(s) to pyradigm datasets. Each path is self-contained dataset identifying each sample, its class and features. &quot;&quot;&quot;</span>

    <span class="n">help_text_data_matrix</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;List of absolute paths to text files containing one matrix of size N x p  (num_samples x num_features).  Each row in the data matrix file must represent data corresponding  to sample in the same row of the meta data file (meta data file and data matrix must be in row-wise correspondence). Name of this file will be used to annotate the results and visualizations.</span>

<span class="s2">E.g. ``--data_matrix_paths /project/fmri.csv /project/dti.csv /project/t1_volumes.csv ``</span>
<span class="s2">    </span>
<span class="s2">Only one of ``--pyradigm_paths``, ``user_feature_paths`` and ``daa_matrix_path`` options can be specified.  </span>
<span class="s2">File format could be </span>
<span class="s2"> - a simple comma-separated text file (with extension .csv or .txt): which can easily be read back with numpy.loadtxt(filepath, delimiter=&#39;,&#39;) or </span>
<span class="s2"> - a numpy array saved to disk (with extension .npy or .numpy) that can read in with numpy.load(filepath). </span>
<span class="s2"> </span>
<span class="s2"> One could use ``numpy.savetxt(data_array, delimiter=&#39;,&#39;)`` or ``numpy.save(data_array)`` to save features. File format is inferred from its extension.&quot;&quot;&quot;</span>

    <span class="n">help_text_positive_class</span> <span class="o">=</span> <span class="s2">&quot;Name of the positive class (Alzheimers, MCI or Parkinsons etc) to be used in calculation of area under the ROC curve. Applicable only for binary classification experiments. Default: class appearning second in order specified in metadata file.&quot;</span>
    <span class="n">help_text_train_perc</span> <span class="o">=</span> <span class="s2">&quot;Percentage of the smallest class to be reserved for training. Must be in the interval [0.01 0.99].If sample size is sufficiently big, we recommend 0.5.If sample size is small, or class imbalance is high, choose 0.8.&quot;</span>

    <span class="n">help_text_num_rep_cv</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Number of repetitions of the repeated-holdout cross-validation. The larger the number, the better the estimates will be.&quot;&quot;&quot;</span>

    <span class="n">help_text_sub_groups</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;This option allows the user to study different combinations of classes in a multi-class (N&gt;2) dataset. For example, in a dataset with 3 classes CN, FTD and AD, two studies of pair-wise combinations can be studied separately with the following flag ``--sub_groups CN,FTD CN,AD``. This allows the user to focus on few interesting subgroups depending on their dataset/goal. </span>
<span class="s2">    </span>
<span class="s2">Format: Different subgroups must be separated by space, and each sub-group must be a comma-separated list of class names defined in the meta data file. Hence it is strongly recommended to use class names without any spaces, commas, hyphens and special characters, and ideally just alphanumeric characters separated by underscores. Any number of subgroups can be specified, but each subgroup must have atleast two distinct classes. </span>

<span class="s2">Default: ``&#39;all&#39;``, leading to inclusion of all available classes in a all-vs-all multi-class setting.&quot;&quot;&quot;</span>

    <span class="n">help_text_metadata_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Abs path to file containing metadata for subjects to be included for analysis. At the minimum, each subject should have an id per row followed by the class it belongs to.</span>

<span class="s2">E.g.</span>
<span class="s2">.. parsed-literal::</span>

<span class="s2">    sub001,control</span>
<span class="s2">    sub002,control</span>
<span class="s2">    sub003,disease</span>
<span class="s2">    sub004,disease</span>
<span class="s2">    </span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">help_text_feature_selection</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Number of features to select as part of feature selection. Options:</span>

<span class="s2"> - &#39;tenth&#39;</span>
<span class="s2"> - &#39;sqrt&#39;</span>
<span class="s2"> - &#39;log2&#39;</span>
<span class="s2"> - &#39;all&#39;</span>

<span class="s2">Default: </span><span class="se">\&#39;</span><span class="s2">tenth</span><span class="se">\&#39;</span><span class="s2"> of the number of samples in the training set. For example, if your dataset has 90 samples, you chose 50 percent for training (default),  then Y will have 90*.5=45 samples in training set, leading to 5 features to be selected for taining. If you choose a fixed integer, ensure all the feature sets under evaluation have atleast that many features.&quot;&quot;&quot;</span>

    <span class="n">help_text_atlas</span> <span class="o">=</span> <span class="s2">&quot;Name of the atlas to use for visualization. Default: fsaverage, if available.&quot;</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--meta_file&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;meta_file&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_metadata_file</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--out_dir&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;out_dir&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output folder to store gathered features &amp; results.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--fs_subject_dir&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;fs_subject_dir&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_fs_dir</span><span class="p">)</span>

    <span class="n">user_defined</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>

    <span class="n">user_defined</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;--pyradigm_paths&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;pyradigm_paths&quot;</span><span class="p">,</span>
                              <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>  <span class="c1"># to allow for multiple features</span>
                              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="n">help_text_pyradigm_paths</span><span class="p">)</span>

    <span class="n">user_defined</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;--user_feature_paths&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;user_feature_paths&quot;</span><span class="p">,</span>
                              <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>  <span class="c1"># to allow for multiple features</span>
                              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="n">help_text_user_defined_folder</span><span class="p">)</span>

    <span class="n">user_defined</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--data_matrix_paths&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;data_matrix_paths&quot;</span><span class="p">,</span>
                              <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="n">help_text_data_matrix</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--positive_class&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;positive_class&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_positive_class</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--train_perc&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;train_perc&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_train_perc</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--num_rep_cv&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;num_rep_cv&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_num_rep_cv</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="s2">&quot;--num_features_to_select&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;num_features_to_select&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_num_features_to_select</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_feature_selection</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--atlas&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;atlasid&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fsaverage&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_atlas</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--sub_groups&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;sub_groups&quot;</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_text_sub_groups</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span></div>


<span class="k">def</span> <span class="nf">organize_inputs</span><span class="p">(</span><span class="n">user_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates the input features specified and returns organized list of paths and readers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_args : ArgParse object</span>
<span class="sd">        Various options specified by the user.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    user_feature_paths : list</span>
<span class="sd">        List of paths to specified input features</span>
<span class="sd">    user_feature_type : str</span>
<span class="sd">        String identifying the type of user-defined input</span>
<span class="sd">    fs_subject_dir : str</span>
<span class="sd">        Path to freesurfer subject directory, if supplied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">atleast_one_feature_specified</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">fs_subject_dir</span><span class="p">):</span>
        <span class="n">fs_subject_dir</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">fs_subject_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Given Freesurfer directory doesn&#39;t exist.&quot;</span><span class="p">)</span>
        <span class="n">atleast_one_feature_specified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs_subject_dir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">user_feature_paths</span><span class="p">):</span>
        <span class="n">user_feature_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="n">user_args</span><span class="o">.</span><span class="n">user_feature_paths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">udir</span> <span class="ow">in</span> <span class="n">user_feature_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">udir</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;One of the user directories for features doesn&#39;t exist:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">udir</span><span class="p">))</span>

        <span class="n">atleast_one_feature_specified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user_feature_type</span> <span class="o">=</span> <span class="s1">&#39;dir_of_dirs&#39;</span>

    <span class="k">elif</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">data_matrix_paths</span><span class="p">):</span>
        <span class="n">user_feature_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="n">user_args</span><span class="o">.</span><span class="n">data_matrix_paths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">user_feature_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">dm</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;One of the data matrices specified does not exist:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dm</span><span class="p">))</span>

        <span class="n">atleast_one_feature_specified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user_feature_type</span> <span class="o">=</span> <span class="s1">&#39;data_matrix&#39;</span>

    <span class="k">elif</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">pyradigm_paths</span><span class="p">):</span>
        <span class="n">user_feature_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="n">user_args</span><span class="o">.</span><span class="n">pyradigm_paths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">user_feature_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">pp</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;One of pyradigms specified does not exist:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp</span><span class="p">))</span>

        <span class="n">atleast_one_feature_specified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user_feature_type</span> <span class="o">=</span> <span class="s1">&#39;pyradigm&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_feature_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user_feature_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># map in python 3 returns a generator, not a list, so len() wouldnt work</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_feature_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">user_feature_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_feature_paths</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atleast_one_feature_specified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Atleast one method specifying features must be specified. &#39;</span>
                         <span class="s1">&#39;It can be a path(s) to pyradigm dataset, matrix file, user-defined folder or a Freesurfer subject directory.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Parser/validator for the cmd line args.&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too few arguments!&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># parsing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># noinspection PyUnboundLocalVariable</span>
    <span class="n">meta_file</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">meta_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">meta_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Meta data file doesn&#39;t exist.&quot;</span><span class="p">)</span>

    <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span> <span class="o">=</span> <span class="n">organize_inputs</span><span class="p">(</span><span class="n">user_args</span><span class="p">)</span>

    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output folder could not be created.&#39;</span><span class="p">)</span>

    <span class="n">train_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">train_perc</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">train_perc</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training percentage </span><span class="si">{}</span><span class="s2"> out of bounds - must be &gt;= 0.01 and &lt;= 0.99&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_perc</span><span class="p">))</span>

    <span class="n">num_rep_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">num_rep_cv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_rep_cv</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atleast 10 repetitions of CV is recommened.&quot;</span><span class="p">)</span>

    <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>

    <span class="n">class_set</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">positive_class</span> <span class="o">=</span> <span class="n">validate_class_set</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">user_args</span><span class="o">.</span><span class="n">sub_groups</span><span class="p">,</span> <span class="n">user_args</span><span class="o">.</span><span class="n">positive_class</span><span class="p">)</span>

    <span class="n">feature_selection_size</span> <span class="o">=</span> <span class="n">validate_feature_selection_size</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">num_features_to_select</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> \
           <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span> \
           <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> \
           <span class="n">positive_class</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">feature_selection_size</span>


<span class="k">def</span> <span class="nf">validate_feature_selection_size</span><span class="p">(</span><span class="n">feature_select_method</span><span class="p">,</span> <span class="n">dim_in_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures method chosen for the type of computation for the size of reduced dimensionality.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feature_select_method</span>
<span class="sd">    dim_in_data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">feature_select_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">feature_selection_size_methods</span><span class="p">:</span>
        <span class="n">num_select</span> <span class="o">=</span> <span class="n">feature_select_method</span>
    <span class="k">elif</span> <span class="n">feature_select_method</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">num_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">feature_select_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">num_select</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">UnboundLocalError</span><span class="p">(</span><span class="s1">&#39;feature selection size out of bounds.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;Must be &gt; 0 and &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid choise - Choose an integer or one of </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">feature_selection_size_methods</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">num_select</span>


<span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populates the dataset dictionary with subject ids and classes</span>

<span class="sd">    Currently supports the following per line: subjectid,class</span>
<span class="sd">    Future plans to include demographics data: subjectid,class,age,sex,education</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sample_ids : list of str</span>
<span class="sd">        list of strings identifying the sample ids</span>
<span class="sd">    classes : dict</span>
<span class="sd">        dict of class labels for each id in the sample_ids</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">)</span>

    <span class="n">sample_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># checking for duplicates</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">):</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span> <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate sample ids found!</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Remove duplicates and rerun.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicates</span><span class="p">))</span>

    <span class="n">classes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">meta</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span>


<span class="k">def</span> <span class="nf">get_dir_of_dirs</span><span class="p">(</span><span class="n">featdir</span><span class="p">,</span> <span class="n">subjid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to read in features for a given subject from a user-defined feature folder. This featdir must contain a</span>
<span class="sd">    separate folder for each subject with a file called features.txt with one number per line.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    featdir : str</span>
<span class="sd">        Path to in the input directory</span>
<span class="sd">    subjid : str</span>
<span class="sd">        Subject id (name of the subfolder in the featdir identifying the subject)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : ndarray </span>
<span class="sd">        vector of features for the given subject</span>
<span class="sd">    feat_names : list of str</span>
<span class="sd">        names of each feature</span>
<span class="sd">        Currently None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">feat_names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">featfile</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">featdir</span><span class="p">,</span> <span class="n">subjid</span><span class="p">,</span> <span class="s1">&#39;features.txt&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">featfile</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Unable to load features from </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featfile</span><span class="p">))</span>

    <span class="c1"># the following ensures an array is returned even when data is a single scalar,</span>
    <span class="c1"># for which len() is not defined (which is needed for pyradigm to find dimensionality</span>
    <span class="c1"># order=&#39;F&#39; (column-major) is chosen to as input is expected to be in a single column</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">feat_names</span>


<span class="k">def</span> <span class="nf">get_data_matrix</span><span class="p">(</span><span class="n">featpath</span><span class="p">):</span>
    <span class="s2">&quot;Returns ndarray from data matrix stored in a file&quot;</span>

    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">featpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;.numpy&#39;</span><span class="p">]:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">featpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">]:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">featpath</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid or empty file extension : </span><span class="si">{}</span><span class="se">\n</span><span class="s1"> Allowed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_ext</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">INPUT_FILE_FORMATS</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Unable to load the data matrix from disk.&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">matrix</span>


<span class="k">def</span> <span class="nf">get_pyradigm</span><span class="p">(</span><span class="n">feat_path</span><span class="p">):</span>
    <span class="s2">&quot;Do-nothing reader of pyradigm.&quot;</span>

    <span class="k">return</span> <span class="n">feat_path</span>


<span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">featdir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">get_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;dir_of_dris&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populates the pyradigm data structure with features from a given method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subjects : list or ndarray</span>
<span class="sd">        List of subject IDs</span>
<span class="sd">    classes : dict</span>
<span class="sd">        dict of class labels keyed in by subject id</span>
<span class="sd">    featdir : str</span>
<span class="sd">        Path to input directory to read the features from</span>
<span class="sd">    outdir : str</span>
<span class="sd">        Path to output directory to save the gathered features to.</span>
<span class="sd">    outname : str</span>
<span class="sd">        Name of the feature set</span>
<span class="sd">    get_method : callable</span>
<span class="sd">        Callable that takes in a path and returns a vectorized feature set (e.g. set of subcortical volumes),</span>
<span class="sd">        with an optional array of names for each feature.</span>
<span class="sd">    feature_type : str</span>
<span class="sd">        Identifier of data organization for features.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    saved_path : str</span>
<span class="sd">        Path where the features have been saved to as an MLDataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">get_method</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied get_method is not callable! It must take in a path and return a vectorized feature set and labels.&quot;</span><span class="p">)</span>

    <span class="c1"># generating an unique numeric label for each class (sorted in order of their appearance in metadata file)</span>
    <span class="n">class_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">class_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_set</span><span class="p">):</span>
        <span class="n">class_labels</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

    <span class="n">ids_excluded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;data_matrix&#39;</span><span class="p">:</span>
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">get_data_matrix</span><span class="p">(</span><span class="n">featdir</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">MLDataset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subjid</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;data_matrix&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="p">[</span><span class="n">subjects</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">subjid</span><span class="p">),</span> <span class="p">:]</span>
                <span class="n">feat_names</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="n">get_method</span><span class="p">(</span><span class="n">featdir</span><span class="p">,</span> <span class="n">subjid</span><span class="p">)</span>

            <span class="n">ds</span><span class="o">.</span><span class="n">add_sample</span><span class="p">(</span><span class="n">subjid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">class_labels</span><span class="p">[</span><span class="n">classes</span><span class="p">[</span><span class="n">subjid</span><span class="p">]],</span> <span class="n">classes</span><span class="p">[</span><span class="n">subjid</span><span class="p">],</span> <span class="n">feat_names</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ids_excluded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjid</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Features for </span><span class="si">{}</span><span class="s2"> via </span><span class="si">{}</span><span class="s2"> method could not be read or added. &quot;</span>
                          <span class="s2">&quot;Excluding it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subjid</span><span class="p">,</span> <span class="n">get_method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="c1"># warning for if failed to extract features even for one subject</span>
    <span class="n">alert_failed_feature_extraction</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_excluded</span><span class="p">),</span> <span class="n">ds</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">))</span>

    <span class="c1"># save the dataset to disk to enable passing on multiple dataset(s)</span>
    <span class="n">saved_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saved_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">saved_path</span>


<span class="k">def</span> <span class="nf">alert_failed_feature_extraction</span><span class="p">(</span><span class="n">num_excluded</span><span class="p">,</span> <span class="n">num_read</span><span class="p">,</span> <span class="n">total_num</span><span class="p">):</span>
    <span class="s2">&quot;Alerts user of failed feature extraction and get permission to proceed.&quot;</span>

    <span class="n">allowed_to_proceed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">num_excluded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Features for </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1"> subjects could not be read. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_excluded</span><span class="p">,</span> <span class="n">total_num</span><span class="p">))</span>
        <span class="n">user_confirmation</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Would you like to proceed?  y / [N] : &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_confirmation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;ye&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stopping. </span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;Rerun after completing the feature extraction for all subjects &#39;</span>
                  <span class="s1">&#39;or exclude failed subjects..&#39;</span><span class="p">)</span>
            <span class="n">allowed_to_proceed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># unnecessary</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Proceeding with only </span><span class="si">{}</span><span class="s1"> subjects.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_read</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">allowed_to_proceed</span>


<span class="k">def</span> <span class="nf">saved_dataset_matches</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the dataset on disk contains requested samples with the same classes</span>

<span class="sd">    Returns True only if the path to dataset exists, is not empy,</span>
<span class="sd">    contains the same number of samples, same sample ids and classes as in meta data!</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_spec : MLDataset or str</span>
<span class="sd">        dataset object, or path to one.</span>
<span class="sd">    subjects : list</span>
<span class="sd">        sample ids</span>
<span class="sd">    classes : dict</span>
<span class="sd">        class ids keyed in by sample ids</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">MLDataset</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_spec</span><span class="p">,</span> <span class="n">MLDataset</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dataset_spec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input must be a path or MLDataset.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">class_set</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">make_visualizations</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">outdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces the performance visualizations/comparisons from the cross-validation results.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results_file_path : str</span>
<span class="sd">        Path to file containing results produced by `rhst`</span>

<span class="sd">    outdir : str</span>
<span class="sd">        Path to a folder to store results.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset_paths</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_repetitions</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> \
    <span class="n">pred_prob_per_class</span><span class="p">,</span> <span class="n">pred_labels_per_rep_fs</span><span class="p">,</span> <span class="n">test_labels_per_rep</span><span class="p">,</span> \
    <span class="n">best_params</span><span class="p">,</span> \
    <span class="n">feature_importances_rf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> \
    <span class="n">num_times_misclfd</span><span class="p">,</span> <span class="n">num_times_tested</span><span class="p">,</span> \
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">accuracy_balanced</span><span class="p">,</span> <span class="n">auc_weighted</span><span class="p">,</span> <span class="n">positive_class</span> <span class="o">=</span> \
        <span class="n">rhst</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DISPLAY is not set. Skipping to generate any visualizations.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Can not create output folder.&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">balacc_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">metric_distribution</span><span class="p">(</span><span class="n">accuracy_balanced</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">balacc_fig_path</span><span class="p">,</span>
                                      <span class="n">num_classes</span><span class="p">,</span> <span class="s2">&quot;Balanced Accuracy&quot;</span><span class="p">)</span>

        <span class="n">confmat_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">confusion_matrices</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">confmat_fig_path</span><span class="p">)</span>

        <span class="n">cmp_misclf_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;compare_misclf_rates&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">visualize</span><span class="o">.</span><span class="n">compare_misclf_pairwise</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">cmp_misclf_fig_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_classes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">visualize</span><span class="o">.</span><span class="n">compare_misclf_pairwise_parallel_coord_plot</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span>
                                                                  <span class="n">cmp_misclf_fig_path</span><span class="p">)</span>

        <span class="n">featimp_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;feature_importance&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">feature_importance_map</span><span class="p">(</span><span class="n">feature_importances_rf</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">featimp_fig_path</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>

        <span class="n">misclf_out_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;misclassified_subjects&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">freq_hist_misclassifications</span><span class="p">(</span><span class="n">num_times_misclfd</span><span class="p">,</span> <span class="n">num_times_tested</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">misclf_out_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Error generating the visualizations! Skipping ..&#39;</span><span class="p">)</span>

    <span class="c1"># cleaning up</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">export_results</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">outdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports the results to simpler CSV format for use in other packages!</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results_file_path</span>
<span class="sd">    outdir</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset_paths</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_repetitions</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> \
    <span class="n">pred_prob_per_class</span><span class="p">,</span> <span class="n">pred_labels_per_rep_fs</span><span class="p">,</span> <span class="n">test_labels_per_rep</span><span class="p">,</span> \
    <span class="n">best_params</span><span class="p">,</span> \
    <span class="n">feature_importances_rf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> \
    <span class="n">num_times_misclfd</span><span class="p">,</span> <span class="n">num_times_tested</span><span class="p">,</span> \
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">accuracy_balanced</span><span class="p">,</span> <span class="n">auc_weighted</span><span class="p">,</span> <span class="n">positive_class</span> <span class="o">=</span> \
        <span class="n">rhst</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">)</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_rep_cv</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">num_datasets</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># separating CSVs from the PDFs</span>
    <span class="n">exp_dir</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EXPORT_DIR_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">)</span>

    <span class="c1"># TODO think about how to export predictive probability per class per CV rep</span>
    <span class="c1"># pred_prob_per_class</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving accuracy distribution ..&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">balacc_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy.csv&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">balacc_path</span><span class="p">,</span> <span class="n">accuracy_balanced</span><span class="p">,</span>
                   <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">,</span>
                   <span class="n">fmt</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EXPORT_FORMAT</span><span class="p">,</span>
                   <span class="n">header</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">method_names</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving confusion matrices ..&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">cfmat_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="p">[</span><span class="n">num_classes</span> <span class="o">*</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> <span class="n">num_datasets</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
            <span class="n">confmat_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_names</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">confmat_path</span><span class="p">,</span>
                       <span class="n">cfmat_reshaped</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>  <span class="c1"># NOTICE the transpose</span>
                       <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EXPORT_FORMAT</span><span class="p">,</span>
                       <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;shape of confusion matrix: num_repetitions x num_classes^2&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving misclassfiication rates ..&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">avg_cfmat</span><span class="p">,</span> <span class="n">misclf_rate</span> <span class="o">=</span> <span class="n">visualize</span><span class="o">.</span><span class="n">compute_pairwise_misclf</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
        <span class="n">num_datasets</span> <span class="o">=</span> <span class="n">misclf_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
            <span class="n">cmp_misclf_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;average_misclassification_rates_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_names</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">cmp_misclf_path</span><span class="p">,</span>
                       <span class="n">misclf_rate</span><span class="p">[</span><span class="n">mm</span><span class="p">,</span> <span class="p">:],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EXPORT_FORMAT</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving feature importance values ..&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
            <span class="n">featimp_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;feature_importance_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_names</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">featimp_path</span><span class="p">,</span>
                       <span class="n">feature_importances_rf</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EXPORT_FORMAT</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">,</span>
                       <span class="n">header</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_names</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving subject-wise misclassification frequencies ..&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">perc_misclsfd</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">visualize</span><span class="o">.</span><span class="n">compute_perc_misclf_per_sample</span><span class="p">(</span><span class="n">num_times_misclfd</span><span class="p">,</span> <span class="n">num_times_tested</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
            <span class="n">subwise_misclf_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;subject_misclf_freq_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_names</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>
            <span class="c1"># TODO there must be a more elegant way to write dict to CSV</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">subwise_misclf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">smf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">perc_misclsfd</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">smf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">DELIMITER</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Unable to export the results to CSV files.&#39;</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">validate_class_set</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">positiveclass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Ensures class names are valid and sub-groups exist.&quot;</span>

    <span class="n">class_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">subgroups</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">subgroups</span><span class="p">:</span>
            <span class="n">cls_list</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># ensuring each subgroup has atleast two classes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cls_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;This subgroup </span><span class="si">{}</span><span class="s1"> does not contain two unique classes.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comb</span><span class="p">))</span>

            <span class="c1"># verify each of them were defined in meta</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">cls_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Class </span><span class="si">{}</span><span class="s2"> in combination </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;does not exist in meta data.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">comb</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># using all classes</span>
        <span class="n">subgroups</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_set</span><span class="p">)</span>

    <span class="c1"># the following loop is required to preserve original order</span>
    <span class="c1"># this does not: class_order_in_meta = list(set(classes.values()))</span>
    <span class="n">class_order_in_meta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">class_set</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_order_in_meta</span><span class="p">:</span>
            <span class="n">class_order_in_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_order_in_meta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atleast two classes are required for predictive analysis! &quot;</span>
                         <span class="s2">&quot;Only one given (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">positiveclass</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">positiveclass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_order_in_meta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Positive class specified does not exist in meta data.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                 <span class="s1">&#39;Choose one of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_order_in_meta</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive class specified for AUC calculation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">positiveclass</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">positiveclass</span> <span class="o">=</span> <span class="n">class_order_in_meta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive class inferred for AUC calculation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">positiveclass</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">class_set</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">positiveclass</span>


<span class="k">def</span> <span class="nf">make_dataset_filename</span><span class="p">(</span><span class="n">method_name</span><span class="p">):</span>
    <span class="s2">&quot;File name constructor.&quot;</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;consolidated_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.MLDataset.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">make_time_stamp</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">file_name</span>


<span class="k">def</span> <span class="nf">import_datasets</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">feature_path</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports all the specified feature sets and organizes them into datasets.</span>
<span class="sd">     </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method_list : list of callables</span>
<span class="sd">        Set of predefined methods returning a vector of features for a given sample id and location</span>
<span class="sd">    out_dir : str</span>
<span class="sd">        Path to the output folder</span>

<span class="sd">    subjects : list of str</span>
<span class="sd">        List of sample ids</span>
<span class="sd">    classes : dict</span>
<span class="sd">        Dict identifying the class for each sample id in the dataset.</span>
<span class="sd">    feature_path : list of str</span>
<span class="sd">        List of paths to the root directory containing the features (pre- or user-defined).</span>
<span class="sd">        Must be of same length as method_list</span>
<span class="sd">    feature_type : str</span>
<span class="sd">        a string identifying the structure of feature set.</span>
<span class="sd">        Choices = (&#39;dir_of_dirs&#39;, &#39;data_matrix&#39;)</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------    </span>
<span class="sd">    method_names : list of str</span>
<span class="sd">        List of method names used for annotation.</span>
<span class="sd">    dataset_paths_file : str</span>
<span class="sd">        Path to the file containing paths to imported feature sets.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">method_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">outpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">mm</span><span class="p">,</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_dir_of_dirs</span><span class="p">]:</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_data_matrix</span><span class="p">]:</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_pyradigm</span><span class="p">]:</span>
            <span class="n">loaded_dataset</span> <span class="o">=</span> <span class="n">MLDataset</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_dataset</span><span class="o">.</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="n">loaded_dataset</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">])</span>
            <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">saved_dataset_matches</span><span class="p">(</span><span class="n">loaded_dataset</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
                <span class="n">outpath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;supplied pyradigm dataset does not match samples in the meta data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># adding an index for an even more unique identification</span>
            <span class="c1"># method_name = &#39;{}_{}&#39;.format(cur_method.__name__,mm)</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">cur_method</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">make_dataset_filename</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>

        <span class="n">outpath_dataset</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_dataset_matches</span><span class="p">(</span><span class="n">outpath_dataset</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="n">outpath_dataset</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                                           <span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span>
                                           <span class="n">out_dir</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span>
                                           <span class="n">cur_method</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">)</span>

        <span class="n">outpath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outpath_dataset</span><span class="p">)</span>

    <span class="n">combined_name</span> <span class="o">=</span> <span class="n">uniq_combined_name</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>

    <span class="n">dataset_paths_file</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;datasetlist.&#39;</span> <span class="o">+</span> <span class="n">combined_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_paths_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dpf</span><span class="p">:</span>
        <span class="n">dpf</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">dataset_paths_file</span>


<span class="k">def</span> <span class="nf">uniq_combined_name</span><span class="p">(</span><span class="n">method_names</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">num_char_each_word</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;Function to produce a uniq, and not a long combined name. Recursive&quot;</span>

    <span class="n">re_delimiters_word</span> <span class="o">=</span> <span class="s1">&#39;_|; |, |\*|</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">combined_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
    <span class="c1"># depending on number and lengths of method_names, this can get very long</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="n">first_letters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mname</span> <span class="ow">in</span> <span class="n">method_names</span><span class="p">:</span>
            <span class="n">first_letters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">word</span><span class="p">[:</span><span class="n">num_char_each_word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">re_delimiters_word</span><span class="p">,</span> <span class="n">mname</span><span class="p">)]))</span>
        <span class="n">combined_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_letters</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="n">combined_name</span> <span class="o">=</span> <span class="n">uniq_combined_name</span><span class="p">(</span><span class="n">first_letters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">combined_name</span>


<span class="k">def</span> <span class="nf">make_method_list</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="o">=</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an organized list of feature paths and methods to read in features.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fs_subject_dir : str</span>
<span class="sd">    user_feature_paths : list of str</span>
<span class="sd">    user_feature_type : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    feature_dir : list</span>
<span class="sd">    method_list : list</span>
<span class="sd">    </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">freesurfer_readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">aseg_stats_subcortical</span><span class="p">,</span> <span class="n">aseg_stats_whole_brain</span><span class="p">]</span>
    <span class="n">userdefined_readers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">:</span> <span class="n">get_dir_of_dirs</span><span class="p">,</span>
                           <span class="s1">&#39;data_matrix&#39;</span><span class="p">:</span> <span class="n">get_data_matrix</span><span class="p">,</span>
                           <span class="s1">&#39;pyradigm&#39;</span><span class="p">:</span> <span class="n">get_pyradigm</span><span class="p">}</span>

    <span class="n">feature_dir</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">method_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_feature_paths</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_feature_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">userdefined_readers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Invalid feature type or its reader is not implemented yet!&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">upath</span> <span class="ow">in</span> <span class="n">user_feature_paths</span><span class="p">:</span>
            <span class="n">feature_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upath</span><span class="p">)</span>
            <span class="n">method_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userdefined_readers</span><span class="p">[</span><span class="n">user_feature_type</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fsrdr</span> <span class="ow">in</span> <span class="n">freesurfer_readers</span><span class="p">:</span>
            <span class="n">feature_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">)</span>
            <span class="n">method_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fsrdr</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid specification for features!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Atleast one feature set must be specified.&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Requested features for analysis:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mm</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">feature_dir</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">feature_dir</span><span class="p">,</span> <span class="n">method_list</span>


<div class="viewcode-block" id="run_cli"><a class="viewcode-back" href="../API.html#run_workflow.run_cli">[docs]</a><span class="k">def</span> <span class="nf">run_cli</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO design an API interface for advanced access as an importable package</span>

    <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> \
    <span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> <span class="n">positiveclass</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> \
    <span class="n">feature_selection_size</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="n">feature_dir</span><span class="p">,</span> <span class="n">method_list</span> <span class="o">=</span> <span class="n">make_method_list</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">)</span>

    <span class="c1"># TODO need to be able to parallelize at subgroup- and method-level</span>
    <span class="n">method_names</span><span class="p">,</span> <span class="n">dataset_paths_file</span> <span class="o">=</span> <span class="n">import_datasets</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                                                       <span class="n">feature_dir</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">)</span>

    <span class="n">results_file_path</span> <span class="o">=</span> <span class="n">rhst</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_paths_file</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                 <span class="n">train_perc</span><span class="o">=</span><span class="n">train_perc</span><span class="p">,</span> <span class="n">num_repetitions</span><span class="o">=</span><span class="n">num_rep_cv</span><span class="p">,</span>
                                 <span class="n">positive_class</span><span class="o">=</span><span class="n">positiveclass</span><span class="p">,</span>
                                 <span class="n">feat_sel_size</span><span class="o">=</span><span class="n">feature_selection_size</span><span class="p">)</span>

    <span class="n">make_visualizations</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>

    <span class="n">export_results</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="fit"><a class="viewcode-back" href="../API.html#run_workflow.fit">[docs]</a><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">input_specification</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">train_perc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">num_repetitions</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">positive_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feat_sel_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_num_features_to_select</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive report on the predictive performance for different feature sets and statistically compare them.</span>

<span class="sd">    Main entry point for API access.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_specification : multiple</span>
<span class="sd">        Either</span>
<span class="sd">            - path to a file containing list of paths (each line containing path to a valid MLDataset)</span>
<span class="sd">            - list of paths to MLDatasets saved on disk</span>
<span class="sd">            - list of MLDatasets (not recommended when feature sets and datasets are big in size and number)</span>
<span class="sd">            - list of tuples (to specify multiple features), each element containing (X, y) i.e. data and target labels</span>
<span class="sd">            - a single tuple containing (X, y) i.e. data and target labels</span>
<span class="sd">            - list of paths to CSV files, each containing one type of features.</span>

<span class="sd">            When specifying multiple sets of input features, ensure:</span>
<span class="sd">            - all of them contain the same number of samples</span>
<span class="sd">            - each sample belongs to same class across all feature sets.</span>

<span class="sd">    meta_data : multiple</span>
<span class="sd">        - a path to a meta data file (see :doc:`features` page)</span>
<span class="sd">        - a tuple conaining (sample_id_list, classes_dict), where the first element is list of samples IDs and the second element is a dict (keyed in sample IDs) with values representing their classes.</span>
<span class="sd">    pipeline : object</span>
<span class="sd">        A sciki-learn pipeline describing the sequence of steps (typically a set of feature selections and dimensionality reduction steps followed by classifier).</span>
<span class="sd">        Default: None, which leads to the selection of a Random Forest classifier with no feature selection.</span>
<span class="sd">    method_names : list</span>
<span class="sd">        A list of names to denote the different feature extraction methods</span>
<span class="sd">    out_results_dir : str</span>
<span class="sd">        Path to output directory to save the cross validation results to.</span>
<span class="sd">    train_perc : float, optional</span>
<span class="sd">        Percetange of subjects to train the classifier on.</span>
<span class="sd">        The percentage is applied to the size of the smallest class to estimate</span>
<span class="sd">        the number of subjects from each class to be reserved for training.</span>
<span class="sd">        The smallest class is chosen to avoid class-imbalance in the training set.</span>
<span class="sd">        Default: 0.8 (80%).</span>
<span class="sd">    num_repetitions : int, optional</span>
<span class="sd">        Number of repetitions of cross-validation estimation. Default: 200.</span>
<span class="sd">    positive_class : str</span>
<span class="sd">        Name of the class to be treated as positive in calculation of AUC</span>
<span class="sd">    feat_sel_size : str or int</span>
<span class="sd">        Number of features to retain after feature selection.</span>
<span class="sd">        Must be a method (tenth or square root of the size of smallest class in training set,</span>
<span class="sd">            or a finite integer smaller than the data dimensionality.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results_path : str</span>
<span class="sd">        Path to pickle file containing full set of CV results.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run_cli</span><span class="p">()</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Pradeep Reddy Raamana.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>